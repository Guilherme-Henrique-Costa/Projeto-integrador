<div class="app-container">
  <!-- Sidebar -->
  <nav class="custom-sidebar" [class.collapsed]="!sidebarOpen" aria-label="Navegação admin">
    <div class="cabeca">
      <span class="logo-text">{{ adminNome }}</span>
      <button type="button" class="btn-toggle" (click)="toggleSidebar()" aria-label="Alternar menu">
        <i class="pi pi-bars"></i>
      </button>
    </div>

    <div class="corpo">
      <ul class="menu-list">
        <li *ngFor="let item of sidebarItems; trackBy: trackByIndex">
          <a
            [routerLink]="item.route"
            routerLinkActive="active"
            [routerLinkActiveOptions]="{ exact: true }"
            (click)="item.label === 'Sair' ? sair() : null"
          >
            <i [class]="item.icon"></i>
            <span class="menu-label">{{ item.label }}</span>
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Main -->
  <main class="main-content" [ngClass]="{ 'expanded': !sidebarOpen }">
    <!-- topbar -->
    <div class="topbar-inline">
      <div class="brand">
        <span class="logo">CEUB</span>
        <span class="title">Admin • Relatórios</span>
      </div>

      <div class="actions">
        <button class="btn" (click)="gerarRelatorio()"><i class="pi pi-refresh"></i> Gerar</button>
        <button class="btn" (click)="exportCSV()"><i class="pi pi-download"></i> Exportar CSV</button>
        <button class="btn" (click)="imprimirPDF()"><i class="pi pi-file-pdf"></i> PDF</button>
        <button class="btn btn-outline" (click)="sair()"><i class="pi pi-sign-out"></i> Sair</button>
      </div>
    </div>

    <!-- KPIs -->
    <section class="cards-resumo">
      <div class="resumo-card">
        <div class="kpi-titulo">Registros</div>
        <div class="kpi-valor">{{ kpiTotal }}</div>
      </div>
      <div class="resumo-card">
        <div class="kpi-titulo">Ativos</div>
        <div class="kpi-valor">{{ kpiAtivos }}</div>
      </div>
      <div class="resumo-card">
        <div class="kpi-titulo">Pendentes</div>
        <div class="kpi-valor">{{ kpiPendentes }}</div>
      </div>
      <div class="resumo-card">
        <div class="kpi-titulo">Inativos</div>
        <div class="kpi-valor">{{ kpiInativos }}</div>
      </div>
    </section>

    <!-- Gráficos -->
    <section class="graficos">
      <div class="grafico-card">
        <h3>Status (%)</h3>
        <p-chart type="doughnut" [data]="pieData" [options]="pieOptions"></p-chart>
      </div>

      <div class="grafico-card">
        <h3>Registros por mês</h3>
        <p-chart type="line" [data]="lineData" [options]="lineOptions"></p-chart>
      </div>
    </section>

    <!-- Filtros -->
    <section class="filtros">
      <div class="filtros-grid">
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <input pInputText type="text" [(ngModel)]="busca" (ngModelChange)="aplicarFiltros()"
                 placeholder="Buscar por nome, e-mail, área, cidade…" />
        </span>

        <p-dropdown
          [options]="tiposRelatorio"
          [(ngModel)]="tipoSelecionado"
          placeholder="Tipo"
          [showClear]="true"
          (onChange)="aplicarFiltros()"
          [style]="{ width: '100%' }">
        </p-dropdown>

        <p-calendar
          [(ngModel)]="periodo"
          selectionMode="range"
          dateFormat="dd/mm/yy"
          [showIcon]="true"
          (onSelect)="aplicarFiltros()"
          placeholder="Período">
        </p-calendar>

        <p-dropdown
          [options]="areas"
          [(ngModel)]="filtroArea"
          [showClear]="true"
          placeholder="Área"
          (onChange)="aplicarFiltros()"
          [style]="{ width: '100%' }">
        </p-dropdown>

        <p-dropdown
          [options]="statusOptions"
          [(ngModel)]="filtroStatus"
          [showClear]="true"
          placeholder="Status"
          (onChange)="aplicarFiltros()"
          [style]="{ width: '100%' }">
        </p-dropdown>

        <p-dropdown
          [options]="cidades"
          [(ngModel)]="filtroCidade"
          [showClear]="true"
          placeholder="Cidade"
          (onChange)="aplicarFiltros()"
          [style]="{ width: '100%' }">
        </p-dropdown>
      </div>
    </section>

    <!-- Tabela -->
    <section class="tabela">
      <p-table
        [value]="pagina"
        [tableStyle]="{ 'min-width': '64rem' }"
        responsiveLayout="scroll">
        <ng-template pTemplate="header">
          <tr>
            <th>Nome</th>
            <th>Tipo</th>
            <th>Área</th>
            <th>Status</th>
            <th>Cidade</th>
            <th>Horas</th>
            <th>Criado em</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-r>
          <tr>
            <td>
              <div class="cell-main">
                <i class="pi pi-database user-ico"></i>
                <div class="cell-user">
                  <div class="nome">{{ r.nome }}</div>
                  <div class="email" *ngIf="r.email">{{ r.email }}</div>
                </div>
              </div>
            </td>
            <td>{{ r.tipo }}</td>
            <td>{{ r.area }}</td>
            <td>
              <p-tag
                [severity]="r.status === 'Ativo' ? 'success' : r.status === 'Pendente' ? 'warning' : 'danger'"
                [value]="r.status">
              </p-tag>
            </td>
            <td>{{ r.cidade }}</td>
            <td>{{ r.horas ?? '-' }}</td>
            <td>{{ r.criadoEm | date:'dd/MM/yyyy' }}</td>
          </tr>
        </ng-template>
      </p-table>

      <p-paginator
        [rows]="rows"
        [totalRecords]="filtrados.length"
        [first]="page * rows"
        (onPageChange)="onPageChange($event)"
        [rowsPerPageOptions]="[6,10,20]"
        styleClass="mt-2">
      </p-paginator>
    </section>
  </main>
</div>
