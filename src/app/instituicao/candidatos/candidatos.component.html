<div class="candidatos-container">
  <!-- Sidebar -->
  <nav
    class="custom-sidebar"
    [class.collapsed]="!sidebarOpen"
    aria-label="Menu lateral da instituição"
  >
    <div class="cabeca">
      <span class="logo-text">{{
        (instituicaoNome$ | async) ?? "Instituição"
      }}</span>
      <button
        type="button"
        class="btn-toggle"
        (click)="toggleSidebar()"
        aria-label="Alternar menu"
      >
        <i class="pi pi-bars"></i>
      </button>
    </div>

    <div class="corpo">
      <ul class="menu-list">
        <li *ngFor="let item of sidebarItems; trackBy: trackByIndex">
          <a
            [routerLink]="item.route"
            routerLinkActive="active"
            [routerLinkActiveOptions]="{ exact: true }"
            (click)="item.label === 'Sair' ? sair() : null"
          >
            <i [class]="item.icon"></i>
            <span class="menu-label">{{ item.label }}</span>
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Main -->
  <main class="main-content" [ngClass]="{ expanded: !sidebarOpen }">
    <!-- Topbar -->
    <div class="topbar-inline">
      <div class="brand">
        <span class="logo">CEUB</span>
        <span class="title">Instituição • Candidatos</span>
      </div>
      <button class="btn btn-outline" (click)="sair()">
        <i class="pi pi-sign-out"></i> Sair
      </button>
    </div>

    <!-- Busca -->
    <section class="card search-card">
      <div class="search-bar">
        <span class="p-input-icon-left w-100">
          <i class="pi pi-search"></i>
          <input
            pInputText
            type="text"
            placeholder="Pesquisar vaga ou candidato…"
            [formControl]="searchCtrl"
            aria-label="Pesquisar"
          />
        </span>
        <button
          class="btn icon"
          type="button"
          (click)="searchCtrl.setValue('')"
          title="Limpar"
        >
          <i class="pi pi-times"></i>
        </button>
      </div>
    </section>

    <!-- Grid principal -->
    <section class="grid-2">
      <!-- Vagas com candidatos -->
      <section class="card vagas-card">
        <header class="card-header">
          <h3>Vagas com candidatos</h3>
          <span class="counter" *ngIf="vagasFiltradas$ | async as vgs"
            >{{ vgs.length }} vagas</span
          >
        </header>

        <ng-container *ngIf="!loadingVagas; else vagasLoading">
          <ul class="vaga-list">
            <li
              *ngFor="
                let vaga of (vagasFiltradas$ | async) || [];
                trackBy: trackByIndex
              "
              (click)="selecionarVaga(vaga)"
              [class.active]="vagaSelecionada?.id === vaga.id"
              role="button"
              tabindex="0"
            >
              <div class="vaga-main">
                <div class="vaga-cargo">{{ vaga.cargo }}</div>
                <div class="vaga-local">{{ vaga.localidade }}</div>
              </div>
              <i class="pi pi-chevron-right"></i>
            </li>
          </ul>

          <div
            class="empty"
            *ngIf="((vagasFiltradas$ | async)?.length ?? 0) === 0"
          >
            <i class="pi pi-inbox"></i>
            <p>Nenhuma vaga encontrada.</p>
          </div>
        </ng-container>

        <ng-template #vagasLoading>
          <div class="empty">
            <i class="pi pi-spin pi-spinner"></i>
            <p>Carregando vagas…</p>
          </div>
        </ng-template>
      </section>

      <!-- Candidatos -->
      <section class="card candidatos-card">
        <header class="card-header">
          <h3 *ngIf="vagaSelecionada; else selecioneVaga">
            Candidatos • <span class="hl">{{ vagaSelecionada?.cargo }}</span>
            <small class="muted"> — {{ vagaSelecionada?.localidade }}</small>
          </h3>
          <ng-template #selecioneVaga>
            <h3>Selecione uma vaga</h3>
          </ng-template>
        </header>

        <ng-container *ngIf="vagaSelecionada">
          <ng-container
            *ngIf="
              !loadingCandidatos || ((candidatos$ | async)?.length ?? 0) > 0;
              else candLoading
            "
          >
            <p-table
              [value]="(candidatosFiltrados$ | async) || []"
              [tableStyle]="{ 'min-width': '56rem' }"
              responsiveLayout="scroll"
            >
              <ng-template pTemplate="header">
                <tr>
                  <th>Voluntário</th>
                  <th>E-mail</th>
                  <th>Data</th>
                  <th>Status</th>
                  <th>Ação</th>
                </tr>
              </ng-template>

              <ng-template pTemplate="body" let-c>
                <tr>
                  <td>
                    <b>{{ c.nomeVoluntario }}</b>
                  </td>
                  <td>{{ c.emailVoluntario }}</td>
                  <td>{{ c.dataCandidatura | date : "dd/MM/yyyy" }}</td>
                  <td>
                    <p-tag
                      [severity]="
                        c.status === 'Aprovado'
                          ? 'success'
                          : c.status === 'Pendente'
                          ? 'warning'
                          : 'danger'
                      "
                      [value]="c.status || '—'"
                    ></p-tag>
                  </td>
                  <td>
                    <button
                      *ngIf="c.status === 'Pendente'"
                      class="btn btn-primary"
                      (click)="aprovarCandidatura(c)"
                    >
                      Aprovar
                    </button>
                  </td>
                </tr>
              </ng-template>
            </p-table>

            <div
              class="empty"
              *ngIf="((candidatosFiltrados$ | async)?.length ?? 0) === 0"
            >
              <i class="pi pi-users"></i>
              <p>Nenhum candidato para esta vaga.</p>
            </div>
          </ng-container>

          <ng-template #candLoading>
            <div class="empty">
              <i class="pi pi-spin pi-spinner"></i>
              <p>Carregando candidatos…</p>
            </div>
          </ng-template>
        </ng-container>
      </section>
    </section>
  </main>
</div>
